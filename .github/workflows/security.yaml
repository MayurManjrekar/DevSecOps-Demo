name: Security Checks
on:
  workflow_dispatch:
  push:
    branches: 
      - main
    paths:
      - bookshelf/**
      - .github/workflows/security.yaml

jobs:
  Linting:
    name: Code Linting with Security Rules
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Install dependencies
      run: npm install

    - name: Lint with ESLint
      run: npx eslint .

    # - name: Security Scan (npm audit)
    #   run: npm audit --audit-level=high


  Secrets-check:
    name: Secret Check
    needs: Linting
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read 
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'javascript'

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: '/language:javascript'


    # - name: Checkout code
    #   uses: actions/checkout@v4
    #   with:
    #     fetch-depth: 0 

    # - name: Set up Node.js
    #   uses: actions/setup-node@v4
    #   with:
    #     node-version: 'lts/*'

    # - name: Scan for secrets with gitleaks
    #   uses: zricethezav/gitleaks-action@v1
    #   with:
    #     config-path: '.gitleaks.toml'

    # - name: Handle Gitleaks Findings
    #   if: failure()
    #   run: |
    #     echo "Secret scanning found potential secrets!"
    #     exit 1