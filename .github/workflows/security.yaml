name: Security Checks

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - bookshelf/**
      - .github/workflows/security.yaml

jobs:
  setup:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf
    outputs:
      node-cache: ${{ steps.cache-node.outputs.cache-hit }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Cache Node.js modules
      id: cache-node
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-

    - name: Install dependencies
      run: |
        npm install
        npm install -D eslint-formatter-table

  Linting:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf
    needs: setup
    steps:
    - name: Lint with ESLint
      run: npx eslint . --output-file eslint_report.txt --format table
      continue-on-error: true

    - name: Upload ESLint Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: eslint-report
        path: eslint_report.txt

  Secrets-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf
    needs: setup
    steps:
    - name: Install Gitleaks
      run: sudo apt install -y gitleaks

    - name: Run Gitleaks
      run: gitleaks detect --config .gitleaks.toml --source . --no-git --verbose --exit-code 1 --report-path gitleaks-report.json
      continue-on-error: true

    - name: Upload Gitleaks Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-report
        path: gitleaks-report.json

  Auditing:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/bookshelf
    needs: setup
    steps:
    - name: Run npm audit
      run: npm audit --audit-level=high --json > npm_audit_report.json
      continue-on-error: true

    - name: Upload Audit Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: audit-report
        path: npm_audit_report.json



# name: Security Checks
# on:
#   workflow_dispatch:
#   push:
#     branches:
#       - main
#     paths:
#       - bookshelf/**
#       - .github/workflows/security.yaml

# jobs:
#   Linting:
#     name: Code Linting
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         shell: bash
#         working-directory: ${{ github.workspace }}/bookshelf

#     steps:
#     - name: Checkout
#       uses: actions/checkout@v4

#     - name: Set up Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: 'lts/*'

#     - name: Install dependencies
#       run: |
#         npm install
#         npm install -D eslint-formatter-table

#     - name: Lint with ESLint
#       run: npx eslint . --output-file eslint_report.txt --format table
#       continue-on-error: true
      
#     - name: Upload ESLint Report Artifact
#       uses: actions/upload-artifact@v4
#       with:
#         name: eslint-report
#         path: bookshelf/eslint_report.txt

#   Secrets-check:
#     name: Secret Check 
#     needs: Linting
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         shell: bash
#         working-directory: ${{ github.workspace }}/bookshelf

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: Set up Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: 'lts/*'

#     - name: Install gitleaks
#       run: sudo apt install -y gitleaks

#     - name: Run Gitleaks on aap.js
#       run: gitleaks detect --config .gitleaks.toml --source . --no-git --verbose --exit-code 1 --report-path gitleaks-report.json
#       continue-on-error: true

#     - name: Upload Gitleaks Report as Artifact
#       uses: actions/upload-artifact@v4
#       with:
#         name: gitleaks-report
#         path: bookshelf/gitleaks-report.json

#   Auditing:
#     name: Security Vulnerability Check
#     needs: Secrets-check
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         shell: bash
#         working-directory: ${{ github.workspace }}/bookshelf
 
#     steps:
#     - name: Checkout
#       uses: actions/checkout@v4

#     - name: Set up Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: 'lts/*'

#     - name: Install dependencies
#       run: npm install

#     - name: Security Scan (npm audit)
#       run: npm audit --audit-level=high --json > npm_audit_report.json
#       continue-on-error: true

#     - name: Upload Audit Report Artifact
#       uses: actions/upload-artifact@v4
#       with:
#         name: audit-report
#         path: bookshelf/npm_audit_report.json